<html>
<head>
    <title>FindOut Development Process</title>
    <script src="http://threejs.org/build/three.js"></script>
    <script src="OrbitControls.js"></script>
    <style>
        body {
            font-family: Monospace;
            background-color: #a8ddf8;
            margin: 0px;
            overflow: hidden;

        }
        div {
        }
    </style>
</head>
<script>
    var controls, scene, camera, airPlane, curve, timer, counter = 0, previousCounter = 0, changed = true;

    var tangent = new THREE.Vector3();
    var axis = new THREE.Vector3();
    var up = new THREE.Vector3(0, 1, 0);

    var CurvePart = function(curve, start, end) {
        var partLength = end - start;
        return {
            getPointAt: function(u) {
                return curve.getPointAt(start + u * partLength);
            },
            getTangentAt: function(u) {
                return curve.getTangentAt(start + u * partLength);
            }
        };
    };

    function addTubePart(from, to, color) {
        var curvePart = new CurvePart(curve, from, to);
        var tube = new THREE.TubeGeometry(curvePart, 1, 5, 5, false, false);
        var tm = new THREE.Mesh(tube, new THREE.MeshLambertMaterial({color: color}));
        scene.add(tm);
    }

    var HelixCurve = new THREE.Curve.create(
        function(r, turns, height) {
            this.r = r;
            this.turns = turns;
            this.height = height;
        },
        function(t) {
            return new THREE.Vector3(
                            this.r * Math.sin(2.0 * Math.PI * t * this.turns),
                            t * this.height,
                            this.r * Math.cos(2.0 * Math.PI * t * this.turns)
            );
        }
    );

    function init() {
        renderer = new THREE.WebGLRenderer({alpha: true});
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.getElementById('content').appendChild(renderer.domElement);
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 1, 5000);
        camera.position.set(-600, 200, 300);
        camera.lookAt(new THREE.Vector3(0, 100, 0));
        scene = new THREE.Scene();
        controls = new THREE.OrbitControls(camera, render.domElement);
        controls.addEventListener("change", function() {changed = true;});

        scene.add( new THREE.AmbientLight( 0x888888 ) );

        var pointLight = new THREE.PointLight( 0x888888 , 10, 1000);
        pointLight.position.set(-50, 200, 20);
        scene.add( pointLight );

        var numPoints = 200;

        curve = new THREE.CurvePath();
        curve.add(new THREE.LineCurve3(new THREE.Vector3(-250, 0, 125), new THREE.Vector3(0, 0, 125)));
        curve.add(new HelixCurve(125, 3, 150));
        curve.add(new THREE.LineCurve3(new THREE.Vector3(0, 150, 125), new THREE.Vector3(250, 150, 125)));

        var material = new THREE.LineBasicMaterial({
            color: 0xff00f0,
        });

        var geometry = new THREE.Geometry();
        var curvePoints = curve.getPoints(numPoints);
        for (var i = 0; i < curvePoints.length; i++) {
            geometry.vertices.push(curvePoints[i]);
        }

        var line = new THREE.Line(geometry, material);
        scene.add(line);

        // the airplane
        var bodySpline = new THREE.SplineCurve3([
            new THREE.Vector3(0, 0, 0),
            new THREE.Vector3(1, 0, 0),
            new THREE.Vector3(2.5, 0, 5),
            new THREE.Vector3(2.5, 0, 10),
            new THREE.Vector3(1, 0, 25),
            new THREE.Vector3(1, 0, 40)
        ]);
        var bodyPoints = bodySpline.getPoints(50);
        bodyPoints.push(new THREE.Vector3(0, 0, 40));
        bodyPoints.push(new THREE.Vector3(0, 0, 0));
        var bodyGeom = new THREE.LatheGeometry(bodyPoints);
        bodyGeom.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI / 2.0));

        // make and add right wing
        var wingSpline = new THREE.SplineCurve([
            new THREE.Vector2(2, 0),
            new THREE.Vector2(1.5, 20),
            new THREE.Vector2(1.1, 45),
            new THREE.Vector2(1, 49),
            new THREE.Vector2(.5, 50),
            new THREE.Vector2(0, 49),
            new THREE.Vector2(0, 25),
            new THREE.Vector2(0, 0),
            new THREE.Vector2(2, 0)
        ]);
        var wingShape = new THREE.Shape(wingSpline.getPoints(100));
        var wingGeom = new THREE.ExtrudeGeometry(wingShape, {amount: 0.05, bevelEnabled: false});
        material = new THREE.MeshLambertMaterial({color: 0xffffff});
        wingGeom.applyMatrix(new THREE.Matrix4().makeRotationY(Math.PI / 2.0));
        wingGeom.applyMatrix(new THREE.Matrix4().makeRotationX(Math.PI / 2.0));
        wingGeom.applyMatrix(new THREE.Matrix4().makeTranslation(0, -10, 0));
        THREE.GeometryUtils.merge(bodyGeom, wingGeom);
        // add left wing
        wingGeom.applyMatrix(new THREE.Matrix4().makeRotationY(Math.PI));
        THREE.GeometryUtils.merge(bodyGeom, wingGeom);

        // make and add rudder
        var rudderShape = new THREE.Shape([
            new THREE.Vector2(0, 0),
            new THREE.Vector2(0, 4),
            new THREE.Vector2(-8, 3.5),
            new THREE.Vector2(-8, 1),
            new THREE.Vector2(0, 0)
        ]);
        var rudderGeom = new THREE.ExtrudeGeometry(rudderShape, {amount: 0.05, bevelEnabled: false});
        rudderGeom.applyMatrix(new THREE.Matrix4().makeTranslation(0, -40, 0));
        THREE.GeometryUtils.merge(bodyGeom, rudderGeom);

        // make and add stabilizer
        var stabilizerShape = new THREE.Shape([
            new THREE.Vector2(0, 0),
            new THREE.Vector2(-8, 1),
            new THREE.Vector2(-8, 3.5),
            new THREE.Vector2(0, 4),
            new THREE.Vector2(8, 3.5),
            new THREE.Vector2(8, 1),
            new THREE.Vector2(0, 0)
        ]);
        var stabilizerGeom = new THREE.ExtrudeGeometry(stabilizerShape, {amount: 0.05, bevelEnabled: false});
        stabilizerGeom.applyMatrix(new THREE.Matrix4().makeRotationY(Math.PI / 2.0));
        stabilizerGeom.applyMatrix(new THREE.Matrix4().makeTranslation(-8, -40, 0));
        THREE.GeometryUtils.merge(bodyGeom, stabilizerGeom);
        bodyGeom.applyMatrix(new THREE.Matrix4().makeTranslation(0, 50, 0));


        airPlane = new THREE.Mesh(bodyGeom, material);


        scene.add(airPlane);
        setBoxPos();

        animate();
    }

    function run() {
        counter = 0;
        previousCounter = 0;
        timer = setInterval(moveBox, 50);
    }

    var colors = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff8080, 0x80ff80, 0x8080ff, 0xffff80, 0x808080, 0xffffff];

    function setBoxPos() {
        airPlane.position = curve.getPointAt(counter);
        tangent = curve.getTangentAt(counter).normalize();
        axis.crossVectors(up, tangent).normalize();
        var radians = Math.acos(up.dot(tangent));
        airPlane.quaternion.setFromAxisAngle(axis, radians);
    }
    function moveBox() {
        if (counter <= 1) {
            setBoxPos();
            if (previousCounter < counter) {
                addTubePart(previousCounter, counter, colors[Math.floor(counter * 10) % 4]);
            }
            previousCounter = counter;
            counter += 0.0025
            changed = true;
        } else {
            counter = 0;
            clearInterval(timer);
        }
    }

    function animate() {
        requestAnimationFrame(animate);
        render();
    }

    function render() {
        controls.update();
        if (changed) {
            renderer.render(scene, camera);
            changed = false;
        }
    }
</script>
<body onLoad="init()">
    <div><input id="animate" type="button" value="Run" onclick="run()"/></div>
    <div id="content"></div>
</body>
</html>